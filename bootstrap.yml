---
# Playbook:     bootstrap.yml
# Description:  Install python and pre-requisites
# Author:       Mauro Rosero P,
# Email:        mrosero@libretechnology.com (mauro.rosero@gmail.com)
# Organization: LIBRETECH, S. A.

# Note: Run from some computers with ansible installed
#       Only run in Debian distribution
 
- name: bootstrap.yml
  hosts: all
  become: yes
  become_user: root
  gather_facts: yes

  vars:

    packages2install: 'files/base-packages.dat'

  vars_files:

    - 'vars/sysop-settings.yml'

  tasks:

  - name: Read base packages file ({{ packages2install }})
    read_csv:
      path: '{{ packages2install }}'
      fieldnames: packname,state
      delimiter: ','
    register: packages
    become: no
    delegate_to: localhost

  - name: Install/Retire required base packages
    package:
      name: '{{ item.packname }}'
      state: '{{ item.state }}'
    with_items:
      - '{{ packages.list }}'

  - name: Set timezone to {{ sysop_timezone }}
    timezone:
      name: '{{ sysop_timezone }}'

  - name: Create devops groups ({{ sysop_group }})
    group:
      name: '{{ sysop_group }}'
      gid: '{{ sysop_gid }}'
      system: yes
      state: present

  - name: Ensuring that {{ sysop_group }} is able to use sudo without password
    lineinfile:
      path: /etc/sudoers
      regexp: '^%{{ sysop_group }}'
      line: '%{{ sysop_group }} ALL=(ALL) NOPASSWD: ALL'
      #validate: 'visudo -cf %s'

  - name: Create ansible-control user 
    user: 
      name: ansible-temporal
      comment: 'Ansible Temporal User|{{ sysop_email }}|{{ sysop_company }}|{{ sysop_team }}'
      group: '{{ sysop_group }}'
      append: yes
      groups: '{{ sysop_groups }}'
      password: "{{ ansible_password | password_hash('sha512') }}"
      shell: /bin/bash
      state: present
    when: ansible_ssh_user == sysop_userid

  - name: Create sysop user ({{ sysop_userid }})
    user: 
      name: '{{ sysop_userid }}'
      comment: '{{ sysop_name }}|{{ sysop_email }}|{{ sysop_company }}|{{ sysop_team }}'
      uid: '{{ sysop_uid }}'
      system: yes
      group: '{{ sysop_group }}'
      append: yes
      groups: '{{ sysop_groups }}'
      generate_ssh_key: yes
      ssh_key_comment: '{{ sysop_email }}'
      home: '{{ sysop_home }}{{ sysop_userid }}'
      shell: /bin/bash
      state: present
